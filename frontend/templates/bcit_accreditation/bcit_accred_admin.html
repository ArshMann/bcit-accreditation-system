{% extends 'bcit_accreditation/base.html' %}

{% load static %} <!-- Make sure to load static first -->

{% block title %}Admin Dashboard - BCIT Accreditation System{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/admin.css' %}">
{% endblock %}

{% block content %}
<div class="admin-container">
    <h2 class="mb-4">Admin Dashboard</h2>
    
    <!-- Export Button Container -->
    <div class="exportbuttoncontainer">
        <h4>Export Data</h4>
        <p>Export all database records to an Excel file for offline analysis.</p>
        <a href="{% url 'export' %}" class="export-btn">
            <i class="fas fa-file-export"></i> Export to Excel
        </a>
    </div>

    <!-- Tab Navigation -->
    <div class="admin-tabs">
        <div class="admin-tab active" data-tab="users">Users</div>
        <div class="admin-tab" data-tab="database">Database</div>
    </div>
    
    <!-- Table Admin Content Container -->
    <div class="tableadmincontent">

        <!-- Users Tab Content -->
        <div id="users-tab" class="tab-content active">

            <!-- User Management Table -->
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">User Management</h5>
                </div>

                <div class="card-body">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th class="sortable" data-sort="username">Username</th>
                                <th>Email</th>
                                <th>Role</th>
                                <th class="sortable" data-sort="last_upload">Last Upload Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="user-table-body">
                            {% if users %}
                                {% for user in users %}
                                    <tr class="user-row">
                                        <td>
                                            <div class="user-cell">
                                                <div class="avatar-circle">{{ user.username|slice:":1" }}</div>
                                                <div>
                                                    <div class="username">{{ user.username }}</div>
                                                </div>
                                            </div>
                                        </td>
                                        
                                        <td>
                                            <div class="email">{{ user.email }}</div>
                                        </td>
                                        <td>
                                            <span class="badge {% if user.is_admin %}badge-admin{% else %}badge-faculty{% endif %}">
                                                {% if user.is_admin %}
                                                Admin
                                                {% else %}
                                                Faculty
                                                {% endif %}
                                            </span>
                                        </td>
                                        <td>
                                            <div class="upload-date">
                                                {{ user.last_upload|default:"No uploads" }}
                                            </div>
                                        </td>
                                        <td>
                                            <form action="{% url 'delete_user' %}" method="post" style="display: inline;">
                                                {% csrf_token %}
                                                <input type="hidden" name="id" value="{{ user.id }}">
                                                <button type="submit" class="delete-button">Delete</button>
                                            </form>
                                        </td>
                                    </tr>
                                {% endfor %}
                            {% else %}
                                <tr>
                                    <td colspan="5" class="text-center">No users found</td>
                                </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>
        
        </div>

        <!-- Database Tab Content -->
        <div id="database-tab" class="tab-content">
            <div class="search-container card mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">Search by Student ID</h5>
                </div>
                <div class="card-body">
                    <div class="row align-items-end mb-3">
                        <div class="col-md-6" id="studentIdSearch-container">
                            <label for="studentIdSearch" class="form-label">Please enter student ID</label>
                            <input type="text" id="studentIdSearch" class="form-control" placeholder="e.g. A01234567" 
                                   pattern="^[A-Za-z][0-9]{8}$" title="Student ID must be a letter followed by 8 digits">
                        </div>
                        <div class="col-md-3" id="searchStudentBtn-container">
                            <button id="searchStudentBtn" class="btn btn-primary w-100 search-button">
                                <i class="fas fa-search me-2"></i>Search
                            </button>
                        </div>
                    </div>
                    <div id="response-container" class="mt-4" style="display: none;">
                        <h6 class="search-result-title mb-3">Search Results</h6>
                        <div class="search-result-content">
                            <!-- Content will be populated by JavaScript -->
                        </div>
                    </div>
                </div>
            </div>

            <div class="card mb-4" id="database-card">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Full Database Explorer</h5>
                    <div>
                        <!-- future filter select -->
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="database-container">
                        <table class="database-table" id="data-table">
                            <thead>
                                <tr>
                                    <th class="sortable" data-sort="id">ID</th>
                                    <th class="sortable" data-sort="term">Academic Term</th>
                                    <th class="sortable" data-sort="cohort">Cohort</th>
                                    <th class="sortable" data-sort="program">Program</th>
                                    <th class="sortable" data-sort="prog_term">Program Term</th>
                                    <th class="sortable" data-sort="course">Course</th>
                                    <th class="sortable" data-sort="instr_first_name">Faculty First Name</th>
                                    <th class="sortable" data-sort="instr_last_name">Faculty Last Name</th>
                                    <th class="sortable" data-sort="student_id">Student ID</th>
                                    <th class="sortable" data-sort="ga">Graduate Attribute</th>
                                    <th class="sortable" data-sort="gai">GAI</th>
                                    <th class="sortable" data-sort="achievement_level">Achievement Level</th>
                                    <th class="sortable" data-sort="instr_level">Instructional Level</th>
                                    <th class="sortable" data-sort="assess_title">Assessment Title</th>
                                    <th class="sortable" data-sort="assess_type">Assessment Type</th>
                                    <th class="sortable" data-sort="assess_descript">Assessment Description</th>
                                    <th class="sortable" data-sort="assess_weight">Assessment Weight</th>
                                    <th class="sortable" data-sort="assess_max">Assessment Max Score</th>
                                    <th class="sortable" data-sort="alignment">Assessment Alignment</th>
                                    <th class="sortable" data-sort="clos">Course Learning Outcomes</th>
                                    <th class="sortable" data-sort="total_score">Total Score</th>
                                    <th class="sortable" data-sort="gai_score">GAI Points Achieved</th>
                                    <th class="sortable" data-sort="quest_text">Question Text</th>
                                    <th class="sortable" data-sort="question_max">Question Max</th>
                                    <th class="sortable" data-sort="instr_comments">Comments</th>
                                    <th class="sortable" data-sort="created_at">Created At</th>
                                </tr>
                            </thead>
                            <tbody id="data-table-body">
                                {% if database_entries %}
                                    {% for entry in database_entries %}
                                        <tr>
                                            <td>{{ entry.id }}</td>
                                            <td>{{ entry.term }}</td>
                                            <td>{{ entry.cohort }}</td>
                                            <td>{{ entry.program }}</td>
                                            <td>{{ entry.prog_term }}</td>
                                            <td>{{ entry.course }}</td>
                                            <td>{{ entry.instr_first_name }}</td>
                                            <td>{{ entry.instr_last_name }}</td>
                                            <td>{{ entry.student_id }}</td>
                                            <td>{{ entry.ga }}</td>
                                            <td>{{ entry.gai }}</td>
                                            <td>{{ entry.achievement_level }}</td>
                                            <td>{{ entry.instr_level }}</td>
                                            <td>{{ entry.assess_title }}</td>
                                            <td>{{ entry.assess_type }}</td>
                                            <td>{{ entry.assess_descript }}</td>
                                            <td>%{{ entry.assess_weight }}</td>
                                            <td>{{ entry.assess_max }}</td>
                                            <td>{{ entry.alignment }}</td>
                                            <td>{{ entry.clos }}</td>
                                            <td>{{ entry.total_score }}</td>
                                            <td>{{ entry.gai_score }}</td>
                                            <td>{{ entry.quest_text }}</td>
                                            <td>{{ entry.question_max }}</td>
                                            <td>{{ entry.instr_comments }}</td>
                                            <td>{{ entry.created_at }}</td>
                                        </tr>
                                    {% endfor %}
                                {% else %}
                                    <tr>
                                        <td colspan="26" class="text-center">No data available</td>
                                    </tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Pagination controls -->
                <div class="pagination-controls mt-3 d-flex justify-content-between align-items-center">
                    <div>
                        <span>Showing <span id="showing-start">1</span>-<span id="showing-end">10</span> of <span id="total-records">0</span> records</span>
                    </div>
                    <div>
                        <button id="prev-page" class="btn btn-sm btn-outline-primary" disabled>&laquo; Previous</button>
                        <span id="current-page">Page 1</span>
                        <button id="next-page" class="btn btn-sm btn-outline-primary">Next &raquo;</button>
                    </div>
                    <div>
                        <select id="page-size" class="form-select form-select-sm">
                            <option value="10">10 per page</option>
                            <option value="25">25 per page</option>
                            <option value="50">50 per page</option>
                            <option value="100">100 per page</option>
                        </select>
                    </div>
                </div>

            </div>
        </div>
    </div>
</div>


{% endblock %}

{% block extra_js %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {

        const container = document.querySelector('.container');
        container.classList.add("wider-container")

        // Tab switching functionality
        const tabs = document.querySelectorAll('.admin-tab');
        const tabContents = document.querySelectorAll('.tab-content');
        
        tabs.forEach(tab => {
            tab.addEventListener('click', function() {
                // Remove active class from all tabs and contents
                tabs.forEach(t => t.classList.remove('active'));
                tabContents.forEach(c => c.classList.remove('active'));
                
                // Add active class to selected tab and content
                this.classList.add('active');
                const tabId = this.getAttribute('data-tab');
                document.getElementById(tabId + '-tab').classList.add('active');
            });
        });
        
        // Handle table sorting in users tab
        const tableHeaders = document.querySelectorAll('th.sortable');
        let sortField = null;
        let sortDirection = 'asc';
        
        tableHeaders.forEach(header => {
            header.addEventListener('click', function() {
                const field = this.dataset.sort;
                
                // Toggle direction if same field clicked again
                if (field === sortField) {
                    sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
                } else {
                    sortField = field;
                    sortDirection = 'asc';
                }
                
                // Update UI to show sorting state
                tableHeaders.forEach(h => {
                    h.classList.remove('sort-asc', 'sort-desc');
                });
                
                this.classList.add(sortDirection === 'asc' ? 'sort-asc' : 'sort-desc');
                
                // Sort the table
                sortTable(field, sortDirection);
            });
        });
        
        function sortTable(field, direction) {
            const tbody = document.getElementById('user-table-body');
            const rows = Array.from(tbody.querySelectorAll('tr'));
            
            if (rows.length <= 1) return; // No need to sort if only one or no rows
            
            rows.sort((a, b) => {
                let valueA, valueB;
                
                if (field === 'username') {
                    valueA = a.cells[0].textContent.trim().toLowerCase();
                    valueB = b.cells[0].textContent.trim().toLowerCase();
                } else if (field === 'last_upload') {
                    // Handle "No uploads" text
                    const dateA = a.cells[3].textContent.trim();
                    const dateB = b.cells[3].textContent.trim();
                    
                    valueA = dateA === 'No uploads' ? '1900-01-01' : dateA;
                    valueB = dateB === 'No uploads' ? '1900-01-01' : dateB;
                }
                
                // Standard comparison
                if (valueA < valueB) return direction === 'asc' ? -1 : 1;
                if (valueA > valueB) return direction === 'asc' ? 1 : -1;
                return 0;
            });
            
            // Remove all rows from table
            while (tbody.firstChild) {
                tbody.removeChild(tbody.firstChild);
            }
            
            // Add sorted rows
            rows.forEach(row => {
                tbody.appendChild(row);
            });
        }
        
        // Student ID search functionality
        const studentIdSearch = document.getElementById('studentIdSearch');
        const searchStudentBtn = document.getElementById('searchStudentBtn');
        const responseContainer = document.getElementById('response-container');

        // Event listener for the search button
        searchStudentBtn.addEventListener('click', function() {
            searchStudentId();
        });

        // Also search when pressing Enter
        studentIdSearch.addEventListener('keyup', function(event) {
            if (event.key === 'Enter') {
                searchStudentId();
            }
        });

        // Function to validate student ID format
        function validateStudentId(id) {
            const pattern = /^[A-Za-z][0-9]{8}$/;
            return pattern.test(id);
        }

        // Function to search for student ID
        function searchStudentId() {
            const studentId = studentIdSearch.value.trim();
            
            // Validate format (letter followed by 8 digits)
            if (!validateStudentId(studentId)) {
                alert('Please enter a valid student ID (e.g., A01234567)');
                studentIdSearch.focus();
                return;
            }
            
            // Show loading indicator
            responseContainer.style.display = 'block';
            const searchResultContent = document.querySelector('.search-result-content');
            searchResultContent.innerHTML = '<div class="text-center py-4"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div><p class="mt-2">Searching...</p></div>';
            
            // Making API call to search for the student
            fetch(`/api/student-search/?student_id=${encodeURIComponent(studentId)}`)

                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })

                .then(data => {

                    // Display the results
                    if (data.results && data.results.length > 0) {
                        displayStudentResults(data.results);
                    } else {
                        searchResultContent.innerHTML = `
                            <div class="not-found-message">
                                <i class="fas fa-exclamation-circle me-2"></i>
                                Student ID "${studentId}" not found in database
                            </div>
                        `;
                    }
                })

                .catch(error => {
                    console.error('Error searching for student:', error);
                    searchResultContent.innerHTML = `
                        <div class="not-found-message">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            Error searching for student. Please try again.
                        </div>
                    `;
                });
        }

        // Function to display student search results
        function displayStudentResults(results) {
            const searchResultContent = document.querySelector('.search-result-content');
            
            // Create container for results
            let resultsHtml = '<div class="search-results-container">';
            
            // Create the table to display results
            resultsHtml += `
                <div class="student-result-table">
                    <table>
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Academic Term</th>
                                <th>Cohort</th>
                                <th>Program</th>
                                <th>Program Term</th>
                                <th>Course</th>
                                <th>Faculty First Name</th>
                                <th>Faculty Last Name</th>
                                <th>Student ID</th>
                                <th>Graduate Attribute</th>
                                <th>GAI</th>
                                <th>Achievement Level</th>
                                <th>Instructional Level</th>
                                <th>Assessment Title</th>
                                <th>Assessment Type</th>
                                <th>Assessment Description</th>
                                <th>Assessment Weight</th>
                                <th>Assessment Max Score</th>
                                <th>Assessment Alignment</th>
                                <th>Course Learning Outcomes</th>
                                <th>Total Score</th>
                                <th>GAI Points Achieved</th>
                                <th>Question Text</th>
                                <th>Question Max</th>
                                <th>Comments</th>
                                <th>Created At</th>
                            </tr>
                        </thead>
                        <tbody id="student-search-results-body">
            `;
            
            // Add rows for each result
            results.forEach(entry => {
                resultsHtml += `
                    <tr data-entry-id="${entry.id || ''}">
                        <td>${entry.id || ''}</td>
                        <td>${entry.term || ''}</td>
                        <td>${entry.cohort || ''}</td>
                        <td>${entry.program || ''}</td>
                        <td>${entry.prog_term || ''}</td>
                        <td>${entry.course || ''}</td>
                        <td>${entry.instr_first_name || ''}</td>
                        <td>${entry.instr_last_name || ''}</td>
                        <td>${entry.student_id || ''}</td>
                        <td>${entry.ga || ''}</td>
                        <td>${entry.gai || ''}</td>
                        <td>${entry.achievement_level || ''}</td>
                        <td>${entry.instr_level || ''}</td>
                        <td>${entry.assess_title || ''}</td>
                        <td>${entry.assess_type || ''}</td>
                        <td>${entry.assess_descript || ''}</td>
                        <td>%${entry.assess_weight || ''}</td>
                        <td>${entry.assess_max || ''}</td>
                        <td>${entry.alignment || ''}</td>
                        <td>${entry.clos || ''}</td>
                        <td>${entry.total_score || ''}</td>
                        <td>${entry.gai_score || ''}</td>
                        <td>${entry.quest_text || ''}</td>
                        <td>${entry.question_max || ''}</td>
                        <td>${entry.instr_comments || ''}</td>
                        <td>${entry.created_at || ''}</td>
                    </tr>
                `;
            });
            
            resultsHtml += `
                        </tbody>
                    </table>
                </div>
            `;
            
            // Delete button
            resultsHtml += `
                <div class="search-results-actions">
                    <div class="action-header">
                        <h6>Actions</h6>
                    </div>
                    <div class="action-buttons">
                        ${results.map(entry => `
                            <div class="action-row" id="action-for-${entry.id}">
                                <div class="action-info">
                                    <span class="action-label">Record ID: ${entry.id}</span>
                                    <span class="action-label">Student ID: ${entry.student_id}</span>
                                    <span class="action-label">Course: ${entry.course || 'N/A'}</span>
                                </div>
                                <button class="delete-button delete-search-result" 
                                        data-id="${entry.id}" 
                                        data-student-id="${entry.student_id}">
                                    <i class="fas fa-trash-alt"></i> Delete Record
                                </button>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
            
            resultsHtml += '</div>'; // Close search-results-container
    
            searchResultContent.innerHTML = resultsHtml;
            
            // Event listeners to delete buttons
            document.querySelectorAll('.delete-search-result').forEach(button => {
                button.addEventListener('click', function() {
                    const entryId = this.getAttribute('data-id');
                    const studentId = this.getAttribute('data-student-id');
                    deleteSearchResult(entryId, studentId);
                });
            });
        }
        
        // Table selector for database tab
        let currentPage = 1;
        let pageSize = 10;
        let totalPages = 1;
        let totalRecords = 0;
        let currentTable = 'data_process';
        let sortColumn = 'id';
        let sortOrder = 'asc';

        const tableSelector = document.getElementById('table-selector');
        if (tableSelector) {
            tableSelector.addEventListener('change', function() {
                currentTable = this.value;
                currentPage = 1; // Reset to first page
                loadTableData();
            });
        }

        // Pagination controls
        document.getElementById('prev-page').addEventListener('click', function() {
            if (currentPage > 1) {
                currentPage--;
                loadTableData();
            }
        });

        document.getElementById('next-page').addEventListener('click', function() {
            if (currentPage < totalPages) {
                currentPage++;
                loadTableData();
            }
        });

        document.getElementById('page-size').addEventListener('change', function() {
            pageSize = parseInt(this.value);
            currentPage = 1; // Reset to first page
            loadTableData();
        });

        // Sorting functionality for database table
        document.querySelectorAll('#data-table th.sortable').forEach(header => {
            header.addEventListener('click', function() {
                const column = this.dataset.sort;
                
                // Toggle sort order or set new column
                if (column === sortColumn) {
                    sortOrder = sortOrder === 'asc' ? 'desc' : 'asc';
                } else {
                    sortColumn = column;
                    sortOrder = 'asc';
                }
                
                // Update UI to show sorting state
                document.querySelectorAll('#data-table th').forEach(th => {
                    th.classList.remove('sort-asc', 'sort-desc');
                });
                
                this.classList.add(sortOrder === 'asc' ? 'sort-asc' : 'sort-desc');
                
                // Reload data with new sorting
                loadTableData();
            });
        });

        // Initial data load
        loadTableData();

        // Function to load table data via AJAX
        function loadTableData() {
            showLoading();
            
            // Construct the API URL with pagination and sorting parameters
            const url = `/api/data/${currentTable}?page=${currentPage}&page_size=${pageSize}&sort_by=${sortColumn}&sort_order=${sortOrder}`;
            
            fetch(url)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    hideLoading();
                    updateDataTable(data.results);
                    updatePagination(data.pagination);
                })
                .catch(error => {
                    console.error('Error fetching data:', error);
                    hideLoading();
                    document.getElementById('data-table-body').innerHTML = 
                        '<tr><td colspan="23" class="text-center">Error loading data. Please try again.</td></tr>';
                });
        }

        // Function to show loading overlay
        function showLoading() {
            const container = document.querySelector('.database-container');
            const existingOverlay = container.querySelector('.loading-overlay');
            
            if (!existingOverlay) {
                const overlay = document.createElement('div');
                overlay.className = 'loading-overlay';
                overlay.innerHTML = '<div class="spinner"></div>';
                container.style.position = 'relative';
                container.appendChild(overlay);
            }
        }

        // Function to hide loading overlay
        function hideLoading() {
            const overlay = document.querySelector('.loading-overlay');
            if (overlay) {
                overlay.remove();
            }
        }

        // Function to update pagination info
        function updatePagination(pagination) {
            if (!pagination) return;
            
            totalPages = pagination.total_pages;
            totalRecords = pagination.total_records;
            
            document.getElementById('showing-start').textContent = pagination.start_record;
            document.getElementById('showing-end').textContent = pagination.end_record;
            document.getElementById('total-records').textContent = pagination.total_records;
            document.getElementById('current-page').textContent = `Page ${currentPage}`;
            
            // Enable/disable prev/next buttons
            document.getElementById('prev-page').disabled = currentPage === 1;
            document.getElementById('next-page').disabled = currentPage >= totalPages;
        }

        // Function to update the data table with new data
        function updateDataTable(data) {
            // print("data: ",data)
            const tableBody = document.getElementById('data-table-body');
            tableBody.innerHTML = '';
            
            if (!data || data.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="23" class="text-center">No data available</td></tr>';
                return;
            }
            
            data.forEach(entry => {
                const row = document.createElement('tr');
                
                // Create cells for each field
                row.innerHTML = `
                    <td>${entry.id || ''}</td>
                    <td>${entry.term || ''}</td>
                    <td>${entry.cohort || ''}</td>
                    <td>${entry.program || ''}</td>
                    <td>${entry.prog_term || ''}</td>
                    <td>${entry.course || ''}</td>
                    <td>${entry.instr_first_name || ''}</td>
                    <td>${entry.instr_last_name || ''}</td>
                    <td>${entry.student_id || ''}</td>
                    <td>${entry.ga || ''}</td>
                    <td>${entry.gai || ''}</td>
                    <td>${entry.achievement_level || ''}</td>
                    <td>${entry.instr_level || ''}</td>
                    <td>${entry.assess_title || ''}</td>
                    <td>${entry.assess_type || ''}</td>
                    <td>${entry.assess_descript || ''}</td>
                    <td>%${entry.assess_weight || ''}</td>
                    <td>${entry.assess_max || ''}</td>
                    <td>${entry.alignment || ''}</td>
                    <td>${entry.clos || ''}</td>
                    <td>${entry.total_score || ''}</td>
                    <td>${entry.gai_score || ''}</td>
                    <td>${entry.quest_text || ''}</td>
                    <td>${entry.question_max || ''}</td>
                    <td>${entry.instr_comments || ''}</td>
                    <td>${entry.created_at || ''}</td>
                `;

                
                tableBody.appendChild(row);
            });
        }

        // Function to delete a search result via AJAX
        function deleteSearchResult(id, studentId) {
            if (!confirm(`Are you sure you want to delete this record for student ${studentId}?`)) {
                return;
            }
            
            // Create form data
            const formData = new FormData();
            formData.append('id', id);
            formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
            
            // Show loading indicator in the action row
            const actionRow = document.getElementById(`action-for-${id}`);
            if (actionRow) {
                actionRow.classList.add('deleting');
                actionRow.innerHTML = '<div class="spinner-border spinner-border-sm text-primary" role="status"></div> Deleting record...';
            }
            
            // Also update the table row with some visual indication
            const tableRow = document.querySelector(`tr[data-entry-id="${id}"]`);
            if (tableRow) {
                tableRow.classList.add('deleting');
            }
            
            // Send AJAX request to delete the entry
            fetch('{% url "delete_entry" %}', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    // If deletion was successful, remove the rows
                    if (tableRow) tableRow.remove();
                    if (actionRow) actionRow.remove();
                    
                    // Check if there are any results left
                    const tbody = document.getElementById('student-search-results-body');
                    if (tbody && tbody.children.length === 0) {
                        document.querySelector('.search-result-content').innerHTML = `
                            <div class="not-found-message">
                                <i class="fas fa-exclamation-circle me-2"></i>
                                No records found for student ID "${studentId}"
                            </div>
                        `;
                    }
                    
                    // Also refresh the main data table if it's visible
                    if (document.getElementById('database-tab').classList.contains('active')) {
                        loadTableData();
                    }
                } else {
                    // If deletion failed, show error and restore the rows
                    alert('Failed to delete record: ' + (data.message || 'Unknown error'));
                    // Re-search to restore the correct data
                    searchStudentId();
                }
            })
            .catch(error => {
                console.error('Error deleting record:', error);
                alert('Error deleting record. Please try again.');
                // Re-search to restore the correct data
                searchStudentId();
            });
        }
    });
</script>
{% endblock %}